#!/bin/bash

# IntelliJ Action CLI
# Direct HTTP interface to IntelliJ actions
# Usage: ij <action> [action2] [action3] ...
# Example: ij About
# Example: ij SaveAll ReformatCode

# Custom server (no rate limiting)
CUSTOM_API="http://localhost:63343/api/intellij-actions"
# Built-in IntelliJ API (may have rate limiting)
BUILTIN_API="http://localhost:63342/api/intellij-actions"

# Check for flags
FORCE_BUILTIN=false
DISCOVERY_MODE=""
DETACH_MODE=false
QUIET_MODE=false
FORCE_MODE=false

# Parse short flags first (e.g., -dqf)
while [[ "$1" == -* ]] && [[ "$1" != --* ]]; do
    if [[ "$1" == -* ]]; then
        # Handle combined short flags like -dqf
        FLAGS="${1#-}"
        for (( i=0; i<${#FLAGS}; i++ )); do
            FLAG="${FLAGS:$i:1}"
            case "$FLAG" in
                d) DETACH_MODE=true ;;
                q) QUIET_MODE=true ;;
                f) FORCE_MODE=true ;;
                *) echo "Unknown flag: -$FLAG"; exit 1 ;;
            esac
        done
        shift
    fi
done

# Parse long flags
while [[ "$1" == --* ]]; do
    case "$1" in
        --detach)
            DETACH_MODE=true
            shift
            ;;
        --quiet)
            QUIET_MODE=true
            shift
            ;;
        --force)
            FORCE_MODE=true
            shift
            ;;
        --force-builtin)
            FORCE_BUILTIN=true
            shift
            ;;
        --search)
            DISCOVERY_MODE="search"
            shift
            break
            ;;
        --explain)
            DISCOVERY_MODE="explain"
            shift
            break
            ;;
        --list)
            DISCOVERY_MODE="list"
            shift
            break
            ;;
        --history)
            DISCOVERY_MODE="history"
            shift
            break
            ;;
        --stats)
            DISCOVERY_MODE="stats"
            shift
            break
            ;;
        --suggestions)
            DISCOVERY_MODE="suggestions"
            shift
            break
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Handle discovery modes
if [ -n "$DISCOVERY_MODE" ]; then
    case "$DISCOVERY_MODE" in
        search)
            if [ $# -eq 0 ]; then
                echo "Usage: ij --search <query>"
                exit 1
            fi
            curl -s "${CUSTOM_API}/search?q=$1" | jq '.'
            exit 0
            ;;
        explain)
            if [ $# -eq 0 ]; then
                echo "Usage: ij --explain <action>"
                exit 1
            fi
            curl -s "${CUSTOM_API}/explain?action=$1" | jq '.'
            exit 0
            ;;
        list)
            echo "Fetching all available actions..."
            curl -s "${CUSTOM_API}/list" | jq '.count'
            echo "Use 'ij --search <query>' to search for specific actions"
            exit 0
            ;;
        history)
            LIMIT="${1:-50}"
            curl -s "${CUSTOM_API}/history?limit=$LIMIT" | jq '.'
            exit 0
            ;;
        stats)
            if [ $# -gt 0 ]; then
                # Get stats for specific action
                curl -s "${CUSTOM_API}/stats?action=$1" | jq '.'
            else
                # Get top actions
                curl -s "${CUSTOM_API}/stats" | jq '.'
            fi
            exit 0
            ;;
        suggestions)
            curl -s "${CUSTOM_API}/suggestions" | jq '.'
            exit 0
            ;;
    esac
fi

# Check if at least one action is provided
if [ $# -eq 0 ]; then
    echo "Usage: ij [options] <action> [action2] [action3] ..."
    echo ""
    echo "Fire-and-forget options:"
    echo "  -d, --detach     Fire and forget - send request and exit immediately"
    echo "  -q, --quiet      Suppress all output"
    echo "  -f, --force      Continue chain even if actions fail"
    echo ""
    echo "Execution options:"
    echo "  --force-builtin  Use built-in API instead of custom server"
    echo ""
    echo "Discovery options:"
    echo "  --search <query>  Search for actions matching query"
    echo "  --explain <action>  Show action requirements and description"
    echo "  --list  Show count of all available actions"
    echo ""
    echo "Analytics options:"
    echo "  --history [limit]  Show recent execution history (default: 50)"
    echo "  --stats [action]  Show statistics for all or specific action"
    echo "  --suggestions  Show usage suggestions and patterns"
    echo ""
    echo "Examples:"
    echo "  ij About"
    echo "  ij SaveAll ReformatCode"
    echo "  ij -d SaveAll                  # Fire and forget"
    echo "  ij -dq SaveAll ReformatCode     # Detached + quiet"
    echo "  ij -f Action1 Action2           # Continue on failures"
    echo "  ij -dqf Chain1 Chain2           # All flags combined"
    echo "  ij --search format"
    echo "  ij --explain ReformatCode"
    echo "  ij --history 20"
    echo "  ij --stats ReformatCode"
    echo ""
    echo "Common actions:"
    echo "  About, ShowSettings, SaveAll, ReformatCode, OptimizeImports"
    echo "  FindInPath, GotoDeclaration, Run, Debug, ToggleBookmark"
    exit 1
fi

# Build the URL path based on number of actions
if [ $# -eq 1 ]; then
    # Single action
    URL_PATH="/execute?action=$1"
else
    # Multiple actions
    ACTIONS=$(IFS=,; echo "$*")
    URL_PATH="/execute?actions=${ACTIONS}"
fi

# Add force parameter if force mode is enabled
if [ "$FORCE_MODE" = true ]; then
    URL_PATH="${URL_PATH}&force=true"
fi

# Handle detach mode - fire and forget
if [ "$DETACH_MODE" = true ]; then
    if [ "$QUIET_MODE" = true ]; then
        # Detach + quiet: complete silence
        curl -s "${CUSTOM_API}${URL_PATH}" >/dev/null 2>&1 &
    else
        # Detach only: minimal output
        echo "→ Detached: $*"
        curl -s "${CUSTOM_API}${URL_PATH}" >/dev/null 2>&1 &
    fi
    exit 0
fi

# Function to execute request
execute_request() {
    local API_BASE=$1
    local RESPONSE=$(curl -s -m 2 "${API_BASE}${URL_PATH}" 2>&1)
    local EXIT_CODE=$?
    
    if [ $EXIT_CODE -eq 0 ]; then
        # Check for rate limiting error
        if echo "$RESPONSE" | grep -q "429 Too Many Requests"; then
            echo "rate_limited"
            return 1
        fi
        # Check if response indicates success
        if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "$RESPONSE"
            return 0
        elif echo "$RESPONSE" | grep -q '"success":false'; then
            echo "$RESPONSE"
            return 2
        fi
    fi
    echo "connection_failed"
    return 1
}

# Try custom server first (unless forced to use built-in)
SUCCESS=false
if [ "$FORCE_BUILTIN" = false ]; then
    RESPONSE=$(execute_request "$CUSTOM_API")
    RESULT=$?
    
    if [ $RESULT -eq 0 ]; then
        if [ "$QUIET_MODE" = false ]; then
            echo "✓ Action executed: $*"
        fi
        SUCCESS=true
    elif [ $RESULT -eq 2 ]; then
        if [ "$QUIET_MODE" = false ]; then
            echo "✗ Action failed: $*"
            echo "Response: $RESPONSE"
        fi
        # Only exit on failure if not in force mode
        if [ "$FORCE_MODE" = false ]; then
            exit 1
        fi
    fi
fi

# If custom server failed or force built-in, try built-in API
if [ "$SUCCESS" = false ]; then
    RESPONSE=$(execute_request "$BUILTIN_API")
    RESULT=$?
    
    if [ $RESULT -eq 0 ]; then
        if [ "$QUIET_MODE" = false ]; then
            echo "✓ Action executed: $*"
        fi
    elif [ "$RESULT" -eq 2 ]; then
        if [ "$QUIET_MODE" = false ]; then
            echo "✗ Action failed: $*"
            echo "Response: $RESPONSE"
        fi
        if [ "$FORCE_MODE" = false ]; then
            exit 1
        fi
    elif echo "$RESPONSE" | grep -q "rate_limited"; then
        if [ "$QUIET_MODE" = false ]; then
            echo "✗ Rate limited. The custom server may not be running."
            echo "Try restarting IntelliJ or wait before retrying."
        fi
        if [ "$FORCE_MODE" = false ]; then
            exit 1
        fi
    else
        if [ "$QUIET_MODE" = false ]; then
            echo "Error: Failed to connect to IntelliJ"
            echo "Make sure IntelliJ IDEA is running with the Action Executor plugin"
        fi
        if [ "$FORCE_MODE" = false ]; then
            exit 1
        fi
    fi
fi